name: Build & Release

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., 1.0.0)"
        required: false
        default: ""

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: "8.2"
  NODE_VERSION: "20"

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_name: ${{ steps.version.outputs.release_name }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Generar versión automática
      - name: Generate Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="1.0.0"
          fi
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          BRANCH_NAME=${{ github.ref_name }}

          if [ "$BRANCH_NAME" == "main" ]; then
            RELEASE_NAME="v${VERSION}-${TIMESTAMP}"
            PRERELEASE="false"
          else
            RELEASE_NAME="v${VERSION}-${BRANCH_NAME}-${TIMESTAMP}"
            PRERELEASE="true"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "prerelease=${PRERELEASE}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

          echo "Building release: ${RELEASE_NAME}"

      # Setup PHP
      - name: Setup PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, zip
          coverage: none

      # Cache Composer
      - name: Cache Composer Dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-prod-${{ runner.os }}-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-prod-${{ runner.os }}-

      # Install PHP dependencies (production)
      - name: Install PHP Dependencies (Production)
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
          echo "Composer dependencies installed (production mode)"

      # Setup Node.js
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # Install Node dependencies
      - name: Install Node Dependencies
        run: |
          npm ci
          echo "NPM dependencies installed"

      # Build frontend
      - name: Build Frontend (Vite)
        run: |
          npm run build
          echo "Frontend assets built"

      # Create .env for artisan commands
      - name: Setup Environment for Optimization
        run: |
          cp .env.example .env
          php artisan key:generate

      # Optimize Laravel
      - name: Optimize Laravel
        run: |
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          echo "Laravel optimized"

      # Create version file
      - name: Create Version File
        run: |
          echo '{
            "version": "${{ steps.version.outputs.version }}",
            "release": "${{ steps.version.outputs.release_name }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "built_at": "'$(date -Iseconds)'"
          }' > public/version.json
          echo "Version file created"

      # Create release artifact
      - name: Create Release Artifact
        run: |
          ARTIFACT_NAME="sistema-ventas-${{ steps.version.outputs.release_name }}"

          # Create tar.gz excluding unnecessary files
          tar -czvf "${ARTIFACT_NAME}.tar.gz" \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='.env.local' \
            --exclude='storage/app/*' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/data/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='tests' \
            --exclude='*.md' \
            --exclude='.github' \
            --exclude='.editorconfig' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='phpunit.xml' \
            --exclude='vitest.config.js' \
            --exclude='eslint.config.js' \
            --exclude='.claude' \
            .

          # Generate checksum
          sha256sum "${ARTIFACT_NAME}.tar.gz" > "${ARTIFACT_NAME}.tar.gz.sha256"

          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_ENV
          echo "Artifact created: ${ARTIFACT_NAME}.tar.gz"
          ls -lh "${ARTIFACT_NAME}.tar.gz"

      # Upload artifact
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-artifact
          path: |
            ${{ env.artifact_name }}.tar.gz
            ${{ env.artifact_name }}.tar.gz.sha256
          retention-days: 30

      # Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.release_name }}
          name: "Release ${{ steps.version.outputs.release_name }}"
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease == 'true' }}
          generate_release_notes: true
          files: |
            ${{ env.artifact_name }}.tar.gz
            ${{ env.artifact_name }}.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Summary
      - name: Build Summary
        run: |
          echo "## Build & Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| *Release* | \${{ steps.version.outputs.release_name }}\ |" >> $GITHUB_STEP_SUMMARY
          echo "| *Branch* | \${{ github.ref_name }}\ |" >> $GITHUB_STEP_SUMMARY
          echo "| *Commit* | \${{ github.sha }}\ |" >> $GITHUB_STEP_SUMMARY
          echo "| *Artifact* | \${{ env.artifact_name }}.tar.gz\ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release created successfully!" >> $GITHUB_STEP_SUMMARY
